= Natural Language Interface to neo4j-gtfs
v1.2, 2016-02-15
:library: Asciidoctor
:include:
:idprefix:
:numbered:
:imagesdir: docs
:toc: manual
:css-signature: demo
:toc-placement: preamble
:toc:
:icons: font
:source-highlighter: prettify
:project_id: ai-rag-neo4j
:sectanchors: ad


== Project Overview

image::nl_to_nl2.png[natural_language_to_natural_language]

This https://spring.io/projects/spring-ai[Spring AI] based project is meant to demonstrate how https://en.wikipedia.org/wiki/Prompt_engineering#Retrieval-augmented_generation[Retrieval Augmented Generation (RAG)] can be used to generate a JSON formatted request to the https://en.wikipedia.org/wiki/GTFS[GTFS] API as provided by the project https://github.com/tguless/neo4j-gtfs[neo4j-gtfs] using Natural Language.

The computer readable response from the API can then be narrated back to the user in Natural Language by leveraging OpenAI GPT-4.

The database and API used for performing retrievals rely on the project hosted at https://github.com/tguless/neo4j-gtfs[neo4j-gtfs] originally developed by @tguless in 2016 to help calculate travel plans using the open GTFS transit plan file format by leveraging a https://en.wikipedia.org/wiki/Neo4j[Neo4j graph database].

== Example Execution Output

Initial GPT-4 Prompt:
----
Today is Wed May 01 2024 21:44:39 GMT-0400 (EDT). Given the prompt:

"I am going to leave from Westwood train station in NJ to go Hoboekn NJ after 9am on Friday"

I need to convert any relevant dates in the prompt (there may be multiple) to Javascript Date format.

To do it, give me the JS commands to execute without using variables in the format:
{
     '{datetyperequested}' : '{js command to run to set a js variable to the date value as Date object}',
     '{2nd datetyperequested}' : '{js command to run to set a js variable to the date value as Date object}'
}

Make sure to only return properly formatted json and nothing else in your response. Make sure all the required dates are included in the JSON object.
----

Initial GPT-4 Prompt Response:

----
 {
    "departureDateStart": "20240521",
    "departureDateEnd": "20240521"
}
----
---

Response processed through the Mozilla Rhino for Java JS evaluator, and subsequent GTFS compliant date formatting.

----
{
    "departureTime": "20240503",
    "currentDate": "20240501"
}
----

---
Program then generates a follow up GPT-4 Prompt:
----
Given the following API
    @RequestMapping(
        value = "/planTrip",
        method = RequestMethod.POST,
        produces = MediaType.APPLICATION_JSON_VALUE)
    @ResponseBody
    public ArrayList <ArrayList <ArrayList<Stoptime>>>  planTrip(
            @RequestBody TripPlan plan)

Where TripPlan has the following structure:

   @Data
    public class TripPlan {
        private String travelDate;
        private String origStation;
        private String origArrivalTimeLow;
        private String origArrivalTimeHigh;
        private String destStation;
        private String destArrivalTimeLow;
        private String destArrivalTimeHigh;
    }

and where where the relevant dates in the format the API expects are as follows

 {
    "departureTime": "20240503",
    "currentDate": "20240501"
}

and all the time fields must have the format '06:46:00'.

Give me the JSON payload to pass to this API to get the trip plan for the following user request:

"I am going to leave from Westwood train station in NJ to go to point pleasant NJ after 9am on Friday"?
----

---

Machine readable response from GPT-4 to pass to the API provided by the https://github.com/tguless/neo4j-gtfs/blob/e355ad7265efb374cec2950dbf4655f62f88fb16/complete/src/main/java/com/popameeting/gtfs/neo4j/Neo4jWebServiceController.java#L105[/plantTrip] endpoint of the neo4j-gtfs API:

----
{
    "travelDate": "20240503",
    "origStation": "Westwood",
    "origArrivalTimeLow": "09:00:00",
    "origArrivalTimeHigh": "",
    "destStation": "Hoboken",
    "destArrivalTimeLow": "",
    "destArrivalTimeHigh": ""
}
----

Effectively so far we have accomplished the following:

image::nl_to_json.png[natural_language_to_json]

Now our program will post the above payload to localhost:8080/customrest/planTripNoTransfer which will be served up by the project https://github.com/tguless/neo4j-gtfs[neo4j-gtfs].

The endpoint will respond with the payload:

----
[
    [
        [
            {
                "arrivalTime": "07:47:00",
                "departureTime": "07:47:00",
                "stopName": "WESTWOOD",
                "stopSequence": 8,
                "tripId": "4225"
            },
            {
                "arrivalTime": "07:51:00",
                "departureTime": "07:51:00",
                "stopName": "ORADELL",
                "stopSequence": 9,
                "tripId": "4225"
            },
            {
                "arrivalTime": "07:55:00",
                "departureTime": "07:55:00",
                "stopName": "RIVER EDGE",
                "stopSequence": 10,
                "tripId": "4225"
            },
            {
                "arrivalTime": "07:59:00",
                "departureTime": "07:59:00",
                "stopName": "NEW BRIDGE LANDING",
                "stopSequence": 11,
                "tripId": "4225"
            },
            {
                "arrivalTime": "08:03:00",
                "departureTime": "08:03:00",
                "stopName": "ANDERSON STREET",
                "stopSequence": 12,
                "tripId": "4225"
            },
            {
                "arrivalTime": "08:06:00",
                "departureTime": "08:06:00",
                "stopName": "ESSEX STREET",
                "stopSequence": 13,
                "tripId": "4225"
            },
            {
                "arrivalTime": "08:09:00",
                "departureTime": "08:09:00",
                "stopName": "TETERBORO",
                "stopSequence": 14,
                "tripId": "4225"
            },
            {
                "arrivalTime": "08:13:00",
                "departureTime": "08:13:00",
                "stopName": "WOOD-RIDGE",
                "stopSequence": 15,
                "tripId": "4225"
            },
            {
                "arrivalTime": "08:23:00",
                "departureTime": "08:23:00",
                "stopName": "FRANK R LAUTENBERG SECAUCUS LOWER LEVEL",
                "stopSequence": 16,
                "tripId": "4225"
            },
            {
                "arrivalTime": "08:35:00",
                "departureTime": "08:35:00",
                "stopName": "HOBOKEN",
                "stopSequence": 17,
                "tripId": "4225"
            }
        ]
    ],
    [
        [
            {
                "arrivalTime": "07:31:00",
                "departureTime": "07:31:00",
                "stopName": "WESTWOOD",
                "stopSequence": 8,
                "tripId": "4213"
            },
            {
                "arrivalTime": "07:34:00",
                "departureTime": "07:34:00",
                "stopName": "EMERSON",
                "stopSequence": 9,
                "tripId": "4213"
            },
            {
                "arrivalTime": "07:38:00",
                "departureTime": "07:38:00",
                "stopName": "ORADELL",
                "stopSequence": 10,
                "tripId": "4213"
            },
            {
                "arrivalTime": "07:42:00",
                "departureTime": "07:42:00",
                "stopName": "RIVER EDGE",
                "stopSequence": 11,
                "tripId": "4213"
            },
            {
                "arrivalTime": "07:47:00",
                "departureTime": "07:47:00",
                "stopName": "NEW BRIDGE LANDING",
                "stopSequence": 12,
                "tripId": "4213"
            },
            {
                "arrivalTime": "08:04:00",
                "departureTime": "08:04:00",
                "stopName": "FRANK R LAUTENBERG SECAUCUS LOWER LEVEL",
                "stopSequence": 13,
                "tripId": "4213"
            },
            {
                "arrivalTime": "08:16:00",
                "departureTime": "08:16:00",
                "stopName": "HOBOKEN",
                "stopSequence": 14,
                "tripId": "4213"
            }
        ]
    ],
    [
        [
            {
                "arrivalTime": "07:14:00",
                "departureTime": "07:14:00",
                "stopName": "WESTWOOD",
                "stopSequence": 7,
                "tripId": "4219"
            },
            {
                "arrivalTime": "07:17:00",
                "departureTime": "07:17:00",
                "stopName": "EMERSON",
                "stopSequence": 8,
                "tripId": "4219"
            },
            {
                "arrivalTime": "07:21:00",
                "departureTime": "07:21:00",
                "stopName": "ORADELL",
                "stopSequence": 9,
                "tripId": "4219"
            },
            {
                "arrivalTime": "07:25:00",
                "departureTime": "07:25:00",
                "stopName": "RIVER EDGE",
                "stopSequence": 10,
                "tripId": "4219"
            },
            {
                "arrivalTime": "07:29:00",
                "departureTime": "07:29:00",
                "stopName": "NEW BRIDGE LANDING",
                "stopSequence": 11,
                "tripId": "4219"
            },
            {
                "arrivalTime": "07:33:00",
                "departureTime": "07:33:00",
                "stopName": "ANDERSON STREET",
                "stopSequence": 12,
                "tripId": "4219"
            },
            {
                "arrivalTime": "07:36:00",
                "departureTime": "07:36:00",
                "stopName": "ESSEX STREET",
                "stopSequence": 13,
                "tripId": "4219"
            },
            {
                "arrivalTime": "07:39:00",
                "departureTime": "07:39:00",
                "stopName": "TETERBORO",
                "stopSequence": 14,
                "tripId": "4219"
            },
            {
                "arrivalTime": "07:43:00",
                "departureTime": "07:43:00",
                "stopName": "WOOD-RIDGE",
                "stopSequence": 15,
                "tripId": "4219"
            },
            {
                "arrivalTime": "07:54:00",
                "departureTime": "07:54:00",
                "stopName": "FRANK R LAUTENBERG SECAUCUS LOWER LEVEL",
                "stopSequence": 16,
                "tripId": "4219"
            },
            {
                "arrivalTime": "08:06:00",
                "departureTime": "08:06:00",
                "stopName": "HOBOKEN",
                "stopSequence": 17,
                "tripId": "4219"
            }
        ]
    ]
]
----

And then our program invokes another ChatGPT API call to trasnlate the JSON back to english:

----
The travel itinerary is as follows:

1. Trip ID 4225:
- The journey begins at WESTWOOD, with both arrival and departure time at 07:47:00.
- The next stop is ORADELL, with both arrival and departure time at 07:51:00.
- Then the trip continues to RIVER EDGE at 07:55:00, NEW BRIDGE LANDING at 07:59:00, ANDERSON STREET at 08:03:00, ESSEX STREET at 08:06:00, TETERBORO at 08:09:00 and WOOD-RIDGE at 08:13:00.
- The trip then heads to FRANK R LAUTENBERG SECAUCUS LOWER LEVEL at 08:23:00 before finally ending at HOBOKEN at 08:35:00.

2. Trip ID 4213:
- The journey begins at WESTWOOD, with both arrival and departure time at 07:31:00.
- The next stop is EMERSON at 07:34:00, followed by ORADELL at 07:38:00, RIVER EDGE at 07:42:00, and NEW BRIDGE LANDING at 07:47:00.
- The trip then heads to FRANK R LAUTENBERG SECAUCUS LOWER LEVEL at 08:04:00 before finally ending at HOBOKEN at 08:16:00.

3. Trip ID 4219:
- The journey begins at WESTWOOD, with both arrival and departure time at 07:14:00.
- The next stop is EMERSON at 07:17:00, followed by ORADELL at 07:21:00, RIVER EDGE at 07:25:00, NEW BRIDGE LANDING at 07:29:00, ANDERSON STREET at 07:33:00, ESSEX STREET at 07:36:00, and TETERBORO at 07:39:00.
- The trip then heads to WOOD-RIDGE at 07:43:00 and FRANK R LAUTENBERG SECAUCUS LOWER LEVEL at 07:54:00 before finally ending at HOBOKEN at 08:06:00.
----

Note, we really don't need to utilize the OpenAI GPT-4 API to translate the last JSON payload back into english.  It should be easy enough to use it to populate a templated text meant to be consumed by humans.